!input package
!input typing
@package lang.oracle
@import lang[trace]
@import lang.typing[True]

let yield_sig = signal
let num_yielded = 0
let yield = func() {
    num_yielded = num_yielded + 1
    wait yield_sig
}
@export yield

let Delayed = type[at, fut]
# let delayed_notifies
let sleep = func(duration) {
    # TODO
}

spawn func() {
    loop {
        intrinsic oracle_advance_signal[oracle_advance]
        wait oracle_advance
        trace("[oracle] waked up")

        match num_yielded != 0 case True => {
            notify yield_sig
            num_yielded = 0
            continue
        }

        trace("[oracle] exit")
        break
    }
}
